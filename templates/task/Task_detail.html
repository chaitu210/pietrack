{% extends 'base.html' %}
{% load project_tags %}
{% load static %}
{% block content %}
<section id='base_content'>
<div class="project_description">
<!-- about project -->
<div class="col-md-9 about_project_wrap">
  <div class="title">
    <span>{{task.name}}</span>
  </div>
  <div class="profile-pic-count">
    <div class="col-md-12 content">
      <div class="profile-content">
        <div class="task_details">
          <b>Created By : </b>
          {{task.created_by.username}} ,
          <em> {{task.created_date|date:"d F,Y \a\t P"}}</em>
        </div>
        <span class="desc">
        {{task.description}}
        </span>
        <div class="attachments_wrap">
          {% for attachment in task.attachments.all %}
          <div class="attachment_each">
            <i class='fa fa-paperclip'></i>
            {{attachment.attached_file}}
            <a href="{{attachment.attached_file.url}}" target="_blank">
              <span class='view_link' data-toggle="modal" >
              <i class='fa fa-eye'></i>
              View
              </span>
            </a>
            <a href="{{attachment.attached_file.url}}" download>
              <span class='download_link'>
              <i class='fa fa-download'></i>
              Download
              </span>
            </a>
            <span class='delete_link'>
              <a href="/project/{{slug}}/task/{{task.id}}/attachment/delete/{{attachment.id}}/">
                <i class='fa fa-trash'></i>
                Delete
              </a>
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
  <div class="clearfix"></div>
  <!-- comments -->
  <div class="comments_wrap_div">
    <!-- your comment -->
    <form action="" method="post" enctype='multipart/form-data' id="comment_form">
      {% csrf_token %}
      <div class="your_comment">
        <textarea name="comment"></textarea>
        <p><span name="error"></span></p>
        <span class="comment_attachment attachment">
          <i class='fa fa-paperclip'></i>
          Attach a file
        </span>
        <!-- <span  name="file_choosen" > selected file here</span> -->
        <input name="file" type="file" value="" class="comment_file" style="display:none;" />
        <button class='comment_btn' type="submit">Comment</button>
      </div>
    </form>
    <!--/ your comment -->
    <!--/ main comment -->
  {% for comment in task|level1comments %}
    <div class="comment_each">
      <div class="img_div">
        <div class="img_wrap">
          {% if comment.commented_by.profile_pic%}
            <img src='{{comment.commented_by.profile_pic.url}}'>
          {% else %}
            <img src='{% static "img/user-pic.jpg" %}'>
          {% endif %}
        </div>
        <div class="name" id="{{comment.id}}">
          {{comment.commented_by}}
          <div class="designation">({{ comment.commented_by|get_user_Role:request.user.organization }} )</div>
          <div class="posted_details">{{comment.created|date:"d F,Y \a\t P"}}</div>
        </div>
      </div>
      <div class="comment_text">
        {{comment.comment}}
        {% for attachment in comment.attachments.all %}
          <div class="attachments_wrap">
            <div class="attachment_each">
              <i class='fa fa-paperclip'></i>
              {{attachment.filename}}
              <a href="{{attachment.attached_file.url}}" target="_blank">
                <span class='view_link' data-toggle="modal" >
                  <i class='fa fa-eye'></i>
                  View
                </span>
              </a>
              <a href="{{attachment.attached_file.url}}" download>
                <span class='download_link'>
                  <i class='fa fa-download'></i>
                  Download
                </span>
              </a>
              <span class='delete_link'>
                <a href="/project/{{slug}}/task/{{task.id}}/attachment/delete/{{attachment.id}}/">
                  <i class='fa fa-trash'></i>
                  Delete
                </a>
              </span>
            </div>
          </div>
        {% endfor %}
        <div class="reply_button">
          <button class="reply"><i class='fa fa-reply'></i>Reply</button>
        </div>
      </div>
    </div>
    {% for sub_comment in comment.comment_parent.all %}
      {% for comment in sub_comment|sub_comments %}
    <!-- sub comment -->
        <div class="sub_comment">
          <div class="comment_each">
            <div class="img_div">
              <div class="img_wrap">
                {% if comment.commented_by.profile_pic%}
                  <img src='{{comment.commented_by.profile_pic.url}}'> 
                {% else %}
                  <img src='{% static "img/user-pic.jpg" %}'>
                {% endif %}
              </div>
              <div class="name" id="{{comment.id}}">
                {{comment.commented_by}}
                <div class="designation">({{ comment.commented_by|get_user_Role:request.user.organization }} )</div>
                <div class="posted_details">{{comment.created|date:"d F,Y \a\t P"}}</div>
              </div>
            </div>
            <div class="comment_text">
              {{comment.comment}}
              {% for attachment in comment.attachments.all %}
                  <div class="attachments_wrap">
                    <div class="attachment_each">
                      <i class='fa fa-paperclip'></i>
                      {{attachment}}
                      <a href="{{attachment.attached_file.url}}" target="_blank"><span class='view_link' data-toggle="modal" ><i class='fa fa-eye'></i>View</span></a>
                      <a href="{{attachment.attached_file.url}}" download>
                        <span class='download_link'>
                          <i class='fa fa-download'></i>
                          Download
                        </span>
                      </a>
                      <span class='delete_link'>
                        <a href="/project/{{slug}}/task/{{task.id}}/attachment/delete/{{attachment.id}}/">
                          <i class='fa fa-trash'></i>
                          Delete
                        </a>
                      </span>
                    </div>
                  </div>
              {% endfor %}
              <div class="reply_button">
                <button class="reply"><i class='fa fa-reply'></i>Reply</button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endfor %}
    <!--/ sub comment -->
  {% endfor %}
    <!-- main comment -->
  </div>
  <!--/ comments -->
</div>
<!--/ about project -->
<!-- team -->
<div class="col-md-3 team">
  <div class="title">
    <span>team members</span>
  </div>
  <!-- ticket -->
  <div class="height_wrap">
    {% for team_member in task|Team_mem %}
    <span class='ticket orange'>
    {%if team_member.profile_pic %}
    <img src="{{ team_member.profile_pic.url }}">
    {% else %}
    <img src="{% static 'img/user-pic.jpg' %}">
    {% endif%}
    <span class='description'>
    <span class='name'>{{team_member.username}}</span>
    <span class='designation_time'>{{team_member|get_user_Role:request.user.organization}}</span>
    </span>
    </span>
    {% endfor %}
    <!--/ ticket -->
  </div>
  <!--/ team -->
 </div>
{%endblock%}
{% block extra_js %}
<script type="text/javascript">
  $('form#comment_form').submit(function(e) {
      var formData = new FormData($(this)[0]);
      var form = this
      $.ajax({
          url: "/project/{{slug}}/task/{{task.id}}/comment/",
          data: formData,
          enctype: 'multipart/form-data',
          processData: false,
          contentType: false,
          type: 'POST',
          success: function(response) {
              if (response['error']) {
                  $("form#comment_form span[name='error']").text(response['errors'].comment)
              } else {
                  $(form).find('textarea').val("")
                  $(form).find('input[name="file"]').val("")
                  $('.your_comment').parent().after(response)
              }
          }
      });
      e.preventDefault()
  });
  
  $('body').on('click', ".reply_button button", function(e) {
  
      if ($(this).parent().parent().parent().next().find('form').length == 0) {
          var form_data = $('form#comment_form').html()
          var form = '<form method="post" action="." enctype="multipart/form-data" class="comment_reply">' + form_data + '</form>'
          var reply = $($.parseHTML('<div class="sub_comment"></div>'))
          var html = reply.append(form)
          html.attr('id', 'reply_to_parent')
          $(html).find('span[name="error"]').text("")
          $(this).parent().parent().parent().after(html)
      }
  });
  
  
  $('body').on('click', '.comment_attachment', function() {
      $(this).parent().find('.comment_file').click();
  });
  
  $('body').on('submit', 'form.comment_reply', function(e) {
      var id = $(this).parent().prev().find('div.name').attr('id');
      var form = this
      var formData = new FormData($(this)[0]);
      $.ajax({
          url: "/project/{{slug}}/task/{{task.id}}/comment/?parent_id=" + id,
          data: formData,
          enctype: 'multipart/form-data',
          processData: false,
          contentType: false,
          type: 'POST',
          success: function(response) {
              $(this).find("span[name='error']").text(response)
              if (response['error']) {
                  $(form).find("span[name='error']").text(response['errors'].comment)
              } else {
                  if ($(form).parent().parent().hasClass('sub_comment')) {
                      $(form).parent().after(response)
                  } else {
                      var reply = $($.parseHTML('<div class="sub_comment"></div>'))
                      $(form).parent().after(reply.append(response))
                  }
                  $(form).remove()
              }
          }
      });
  
      e.preventDefault();
  });
  
  $('body').on('click', '.delete_link a', function(e) {
      url = $(this).attr('href')
      parent = this
      $.get(url, function(response) {
          if (response) {
              $(parent).closest('.attachment_each').remove();
          }
      });
      e.preventDefault()
  });
</script>
{% endblock %}