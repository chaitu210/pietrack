{% extends 'settings/base.html' %}
{% load project_tags %}
{% load static %}
{% load staticfiles %}

{% block settings_content %}

    <div class="right-container">
        <div class="panel panel-default content-panel content-panel-extra">
            <div class="panel-body">
                <!-- content box starts here -->
                <div class="content_box ">
                    {% if list_of_roles|length == 0 %}
                        <div class="role-alert pull-right member-warning-alert">
                            <div class="alert alert-warning alert-dismissible" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <strong><span class="fa fa-warning"></span></strong> Please create a role to add a member !
                            </div>
                        </div>
                    {% endif %}
                    <br clear="clearfixall" />
                    <div class="title">
                        <h4><span class="status">{{ project.name }} - USER ROLE'S</span></h4>
                     {% if request.user.pietrack_role == 'admin' or request.user|is_project_admin:slug %}
                        <div class="tag">
                            Specify the roles of your projects here.
                        </div>
                        <span class="new">
                            <a href="#" data-toggle="modal" data-target="#myModal">
                                Add New Role
                            </a>
                        </span>
                    {% endif %}
                        <!-- new role add modal starts here -->
                        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content" id="id_hide_role">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                        </button>
                                        <h4 class="modal-title" id="myModalLabel">Add New Role</h4>
                                    </div>
                            {% if request.user.pietrack_role == 'admin' or request.user|is_project_admin:slug %}
                                    <form action="" method="post" id="id_add_role">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <div class="form_group">
                                                <label>Role Name</label>
                                                <input name="name" type="text" class="form-control">
                                                <div class="help">add new class role for your project</div>
                                                <span id="id_role_error" class="help error"></span>
                                            </div>
                                            <div class="form_group">
                                                <label>Do you make this role as Admin?
                                                    <input type="checkbox" name="is_project_admin" value="True"/>
                                                </label>

                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Submit</button>
                                        </div>
                                    </form>
                            {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- new role add modal ends here -->
                    </div>
                    <!-- status table starts here -->
                    <div class="table-responsive member-box">
                        {% if list_of_roles %}
                            <table class="table table-hover" id="role_permissions">
                                <thead>
                                    <tr>
                                        <th>Role</th>
                                        <th>Users</th>
                                    {% if request.user.pietrack_role == 'admin' or request.user|is_project_admin:slug %}
                                        <th>Action</th>
                                    {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                  {% for role in list_of_roles %}
                                    <tr id="{{role.id}}">
                                        <td>{{role.name}} </td>
                                        <td>
                                            {% for user in role.users.all %}
                                              <span class="user-assign">
                                                <a href="#"><i class="fa fa-user"></i> {{user}}</a>
                                              </span>
                                            {% endfor %}
                                        </td>
                                    {% if request.user.pietrack_role == 'admin' or request.user|is_project_admin:slug %}
                                        <td class="actions"><a href="#" class="edit" data-toggle="modal" data-target="#myModal1" onclick="edit_role('{{role.id}}','{{role.name}}','{{role.slug}}')"><i class="fa fa-edit"></i></a> <a onclick="delete_role('{{role.slug}}','{{role.id}}')" href="#" class="delete"><i class="fa fa-trash"></i></a> </td>
                                    {% endif %}
                                    </tr>
                                  {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div>
                                <hr />
                                <center>
                                Please create a new status or use
                                    <span class="badge" id="create_default">
                                        <a href="{% url 'project:member_roles_default' slug %}">default</a>
                                    </span> status list !
                                </center>
                            </div>
                        {% endif %}
                    </div>
                {% if request.user.pietrack_role == 'admin' or request.user|is_project_admin:slug %}
                    <form action="" method="post" id="id_edit_role">
                        {% csrf_token %}
                        <!-- edit role add modal starts here -->
                        <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                        <h4 class="modal-title" id="myModalLabel">Edit Role</h4>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form_group">
                                            <label>Role Name</label>
                                            <input name="role_id" value="0" style="display:none;">
                                            <input name="name" type="text" value="" class="form-control" placeholder="Ex: UX Developer">
                                            <span id="edit_role_error" class="help error"></span>
                                            <div class="help">add new role for your project</div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <input id="edit_slug" val="" style="display:none;" />
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- edit role add modal ends here -->
                    </form>
                    <!-- status table ends here -->
                    <!-- content box starts here -->
                {% endif %}
                </div>
            </div>
        </div>
    </div>

{% endblock settings_content %}

{% block extra_js %}
  <script>
  function edit_role(id, name, slug) {
      $('#id_edit_role input[name="name"]').val(name)
      $('#id_edit_role input[name="role_id"]').val(id)
      $('#edit_slug').val(slug)
  }

  function delete_role(slug, id) {
      $.get('/project/{{slug}}/settings/member_role/' + slug + '/delete/', function(response) {
          if (!response['error']) {
              $("#" + id).remove();
          }
      });

  }

  $("#id_add_role").on('submit', function(e) {
      var data = $("#id_add_role").serialize();
      $.post("{% url 'project:member_role_create' slug %}", data, function(response) {
          if (response['error']) {
              $('#id_role_error').text(response['errors'].name)
          } else {
              var role_id = response['role_id'];
              var role_name = response['role_name'];
              var slug = response['slug'];
              var email =  response['email']
              var row = '<tr id="' + role_id + '"><td>' + role_name + ' </td><td>'+'<span class="user-assign"><a href="#"><i class="fa fa-user"></i>'+email+'</a></span>'+'</td><td class="actions"><a href="#" class="edit" data-toggle="modal" data-target="#myModal1" onclick="edit_role(\'' + role_id + '\',\'' + role_name + '\',\'' + slug + '\')"><i class="fa fa-edit"></i></a> <a href="#" class="delete" onclick="delete_role(\'' + slug + '\',\'' + role_id + '\')"><i class="fa fa-trash"></i></a> </td></tr>'
              $("#role_permissions tbody").append(row);
              $("#id_add_role input[name='name']").val("");
              $('button.close').click();
          }
      });
      e.preventDefault();
  });

  $("#id_edit_role").on('submit', function(e) {
      var data = $("#id_edit_role").serialize();
      var slug = $("#edit_slug").val()

      $.post('/project/{{slug}}/settings/member_role/' + slug + '/edit/', data, function(response) {
          if (response['error']) {
              $('#edit_role_error').text(response['errors'].name)
          } else {
              var role_id = response['role_id'];
              var role_name = response['role_name'];
              var slug = response['slug'];
              $('tbody #' + role_id + ' td:first-child').text(role_name)
              $('tbody #' + role_id + ' a.edit ').attr('onclick', 'edit_role("' + role_id + '","' + role_name + '","' + slug + '")')
              $('tbody #' + role_id + ' a.delete ').attr('onclick', "delete_role('" + slug + "','" + role_id + "')")
              $('button.close').click()
          }
      });
      e.preventDefault();
  });

  $('button.close').on('click', function() {
      $('#id_add_role input[name="name"]').val("")
      $('.error').text("");
  });

  $('.modal').on('hidden.bs.modal', function() {
      $('button.close').click()
  });
  </script>
  <script type="text/javascript">
      $('#project_member_roles').addClass('active');
  </script>

    <script type="text/javascript">
        $('#create_default').on('click', function(event){
            event.preventDefault();
            $.get("{% url 'project:member_roles_default' slug %}", function(response){
               if(response){
                   window.location="/project/{{slug}}/settings/member_roles/";
               }
            });
        });
    </script>

{% endblock %}
