{% extends 'settings/base.html' %}

{% load static %}
{% load staticfiles %}

{% block settings_content %}

    <div class="right-container">
        <div class="panel panel-default content-panel">
            <div class="panel-body">
                <!-- content box starts here -->
                <div class="content_box">
                {% if priority_list|length == 0 %}
                    <div class="role-alert member-warning-alert">
                        <div class="alert alert-warning alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                            <strong><span class="fa fa-warning"></span></strong> Please add some priorities here !
                        </div>
                    </div>
                {% endif %}
                    <div class="title">
                        <h4><span class="status">Issues Priorities</span></h4>
                        <div class="tag">
                            Specify the priorities of your issues here.
                        </div>
                        <span class="new"><a href="#" id="add_new">Add New Priority</a></span>
                    </div>
                    <!-- status table starts here -->
                    <div class="table-responsive color-box">
                        <table class="table table-striped" id="priority">
                            <thead>
                                <tr>
                                    <th width="40%">Color</th>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for priority in priority_list%}
                                <tr id="{{priority.id}}">
                                    <td scope="row">
                                        <div class="input-group colorpicker-component demo demo-auto">
                                            <input type="text" value="{{priority.color}}" class="form-control" />
                                            <span class="input-group-addon">
                                                <i style="cursor: default;"></i>
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        {{priority.name}}
                                    </td>
                                    <td class="actions">
                                        <a href="#" class="edit" onclick="edit_priority('{{priority.color}}','{{priority.name}}','{{priority.slug}}')">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <a href="#" class="delete" onclick="delete_priority('{{priority.slug}}','{{priority.id}}')"><i class="fa fa-trash"></i></a>
                                    </td>
                                </tr>
                            {% endfor%}
                            </tbody>
                        </table>
                        <!-- form start -->
                        <form action="" method="post" style="display:none;" id="add_form">
                            {% csrf_token %}
                            <input id="status" name="status" value="true" style="display:none;">
                            <input id="slug" name="slug" value="" style="display:none;">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th width="40%"></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td scope="row">
                                            <div class="input-group colorpicker-component demo demo-auto">
                                                <input name="color" type="text" value="#666666" class="form-control" />
                                                <span class="input-group-addon"><i></i></span>
                                            </div>
                                        </td>
                                        <td>
                                            <input name="name" value="" type="text" style="width: 100px; padding: 2px; border:1px solid #929292;" placeholder="Priority name" />
                                            <span class="input-empty-error" name="error"></span>
                                        </td>
                                        <td class="actions">
                                            <button type="submit" class="edit"><i class="fa fa-plus"></i></button>
                                            <a class="delete" id="id_reset"><span class="glyphicon glyphicon-remove"></span></a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </form>
                        <!-- form ends here -->
                    </div>
                    <!-- status table ends here -->
                    <!-- content box starts here -->
                </div>
            </div>
        </div>
    </div>

{% endblock settings_content %}

{%block extra_js%}
    <script>
    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    function clear_form() {
        var form = $('form');
        form.css('display', 'none');
        form.find('input[name="name"]').val('');
        $('form span[name="error"]').text('')
        $('#slug').val("")
        $('#status').val("true")
    }

    function edit_priority(color, name, slug) {
        var r = hexToRgb(color).r
        var g = hexToRgb(color).g
        var b = hexToRgb(color).b
        var color_box = '<i style="background-color: rgb(' + r + ',' + g + ',' + b + ');"></i>'

        $('#add_form').css('display', 'block');
        $('#add_form').find("input[name='color']").val(color)
        $('#add_form').find("input[name='name']").val(name)
        $('#status').val("false");
        $('#slug').val(slug)
        $('#add_form span').html(color_box)
        $('.demo').colorpicker();

    }

    function delete_priority(slug, id) {
        $.get('/project/{{slug}}/settings/priority/' + slug + '/delete/', function(response) {
            if (!response.error) {
                $('#' + id).remove();
            }
        });
    }

    $('#add_new').on('click', function() {
        clear_form();
        $('form').css('display', 'block');
    });

    $('#id_reset').on('click', function() {
        clear_form();

    });

    $('#add_form').on('submit', function(e) {
        e.preventDefault();
        if ($('#status').val() == "true") {
            $.post('{% url "project:priority_create" slug %}', $('#add_form').serialize(), function(response) {
                if (response.error) {
                    if (response.errors['name']) {
                        $("span[name='error']").text(' * '+response.errors['name']);
                    }
                } else {

                    var name = response['name'];
                    var color = response['color'];
                    var row_id = response['proj_id']
                    var slug = response['slug']

                    data_row = "<tr id=\"" + row_id + "\"><td scope=\"row\"><div class=\"input-group colorpicker-component demo demo-auto\"><input type=\"text\" value=\"" + color + "\" class=\"form-control\"/><span class=\"input-group-addon\"><i></i></span></div></td><td>" + name + "</td><td class=\"actions\"><a href=\"#\" class=\"edit\" onclick=\"edit_priority('" + color + "','" + name + "','" + slug + "')\"><i class=\"fa fa-edit\"></i></a>&nbsp;<a href=\"#\" class=\"delete\" onclick=\"delete_priority('" + slug + "','" + row_id + "')\"><i class=\"fa fa-trash\"></i></a></td></tr>"
                    $('#priority tbody').append(data_row);
                    $('.demo').colorpicker();
                    clear_form();
                }

            });
        } else {
            var myslug = $('#slug').val();
            $.post('/project/{{slug}}/settings/priority/' + myslug + '/edit/', $('#add_form').serialize(), function(response) {
                if (response.error) {
                    if (response.errors['name']) {
                        $("span[name='error']").text(' * '+response.errors['name']);
                    }
                } else {

                    var name = response['name'];
                    var color = response['color'];
                    var row_id = response['proj_id']
                    var slug = response['slug']

                    $('#' + row_id + ' a.edit').attr('onclick', "edit_priority('" + color + "','" + name + "','" + slug + "')")
                    $('#' + row_id + ' a.delete').attr("onclick", "delete_priority('" + slug + "','" + row_id + "')")
                    $('#' + row_id + ' td:nth-child(2)').text(name)
                    $('#' + row_id + ' input').val(color)
                    var r = hexToRgb(color).r
                    var g = hexToRgb(color).g
                    var b = hexToRgb(color).b
                    var color_box = '<i style="background-color: rgb(' + r + ',' + g + ',' + b + ');"></i>'
                    $('#' + row_id + " span").html(color_box)
                    $('.demo').colorpicker();
                    clear_form();
                }

            });

        }
    });
    </script>
    <script type="text/javascript">
        $('#project_submenu').attr('class', 'arrow-up active');
        $('#project_submenu ul').show().children('li#project_priorities').addClass('active');
    </script>
{% endblock %}
