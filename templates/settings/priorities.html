{% extends 'settings/base.html' %}

{% load static %}
{% load staticfiles %}

{% block settings_content %}

    <div class="right-container">
        <div class="panel panel-default content-panel">
            <div class="panel-body">
                <!-- content box starts here -->
                <div class="content_box">
                    <div class="title">
                        <h4><span class="status">Issues Priorities</span></h4>
                        <div class="tag">
                            Specify the priorities of your issues here.
                        </div>
                        <span class="new"><a href="#" id="add_new">Add New Priority</a></span>
                    </div>
                    <!-- status table starts here -->
                    <div class="table-responsive color-box">

                            <table class="table table-striped" id="priority">
                                <thead>
                                    <tr>
                                        <td></td>
                                        <th width="40%">Color</th>
                                        <th>Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                            {% if priority_list %}
                                {% for priority in priority_list%}
                                    <tr id="{{priority.id}}">
                                        <td>
                                            <span class="glyphicon glyphicon-move"></span>
                                            {% csrf_token %}
                                            <input name="id" value="{{priority.id}}" type="hidden"/>
                                        </td>
                                        <td scope="row">
                                            <div class="input-group colorpicker-component demo demo-auto">
                                                <input name="color" type="text" value="{{priority.color}}" class="form-control" />
                                                <span class="input-group-addon">
                                                    <i style="cursor: default;"></i>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <!--{{priority.name}}-->
                                            <input name="name" value="{{ priority.name }}" type="text" class="form-control" readonly>
                                        </td>
                                        <td class="actions">
                                            <!--<a href="#" class="edit" onclick="edit_priority('{{priority.color}}','{{priority.name}}','{{priority.slug}}')">-->
                                                <a href="#" class="edit" >
                                                    <i class="fa fa-edit"></i>
                                                </a>
                                            <a href="#" class="delete" onclick="delete_priority('{{priority.slug}}','{{priority.id}}')"><i class="fa fa-trash"></i></a>
                                        </td>
                                    </tr>
                                {% endfor%}
                                {% endif %}
                                </tbody>
                            </table>

                       {% if not priority_list %}
                            <div>
                                <hr />
                                <center>
                                Please create a new priority or use
                                    <span class="badge" id="create_default">
                                        <a href="{% url 'project:priority_default' slug %}">default</a>
                                    </span> priorities list !
                                </center>
                            </div>
                        {% endif %}
                        <!-- form start -->
                        <form action="" method="post" style="display:none;" id="add_form">
                            {% csrf_token %}
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th width="40%"></th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <span class="glyphicon glyphicon-move"></span>
                                        </td>
                                        <td scope="row">
                                            <div class="input-group colorpicker-component demo demo-auto">
                                                <input name="color" type="text" value="#666666" class="form-control" />
                                                <span class="input-group-addon"><i></i></span>
                                                <span class="input-empty-error" name="color"></span>

                                            </div>
                                        </td>
                                        <td>
                                            <input name="name" value="" type="text" class="form-control" style="border:1px solid #000" placeholder="Priority name" autofocus/>
                                            <span class="input-empty-error" name="name"></span>
                                        </td>
                                        <td class="actions">
                                            <button type="submit" class="edit"><i class="glyphicon glyphicon-floppy-saved"></i></button>
                                            <a class="delete" id="id_reset"><span class="glyphicon glyphicon-remove"></span></a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </form>
                        <!-- form ends here -->
                    </div>
                    <!-- status table ends here -->
                    <!-- content box starts here -->
                </div>
            </div>
        </div>
    </div>

{% endblock settings_content %}

{%block extra_js%}
<script type="text/javascript" src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script>
    function clear_form() {
        var form = $('form');
        form.css('display', 'none');
        form.find('input[name="name"]').val('');
        form.find('input[name="color"]').val('#666666');
        form.find('input[name="name"]').css({border:'1px solid #000'});
        form.find('input[name="color"]').css({border:'none'});
    }

    function delete_priority(slug, id) {
        $.get('/project/{{slug}}/settings/priority/' + slug + '/delete/', function(response) {
            if (!response.error) {
                $('#' + id).remove();
            }
        });
    }

    $('#add_new').on('click', function() {
        clear_form();
        $('form').css('display', 'block');
    });

    $('#id_reset').on('click', function() {clear_form();});

    $('#add_form').on('submit', function(e) {
        $instance = $(this)
        e.preventDefault();
            $.post('{% url "project:priority_create" slug %}', $('#add_form').serialize(), function(response) {
                if (response.error) {
                    /*if (response.errors['name']) {

                        $("span[name='error']").text(' * '+response.errors['name']);
                    }*/
                    alert("errors")
                    $instance.find('input').css({border:'none'});
                    for (var key in response['errors']) {
                        $input = $instance.find('input[name="'+key+'"]');
                        console.log(key)
                        $input.css({border:'solid 1px #FF0000'});
                    }
                } else {
                    var name = response['name'];
                    var color = response['color'];
                    var row_id = response['proj_id']
                    var slug = response['slug']

                    data_row = "<tr id=\"" + row_id + "\"><td><input name='id' value='"+row_id+"' type='hidden'><span class=\"glyphicon glyphicon-move\"></span>"+"{% csrf_token %}"+"</td><td scope=\"row\"><div class=\"input-group colorpicker-component demo demo-auto\"><input name='color' type=\"text\" value=\"" + color + "\" class=\"form-control\"/><span class=\"input-group-addon\"><i></i></span></div></td><td><input name=\"name\" value=\""+name+"\" type=\"text\" class=\"form-control\" style=\"background:#fff\"></td><td class=\"actions\"><a href=\"#\" class=\"edit\"><i class=\"fa fa-edit\"></i></a>&nbsp;<a href=\"#\" class=\"delete\" onclick=\"delete_priority('" + slug + "','" + row_id + "')\"><i class=\"fa fa-trash\"></i></a></td></tr>"
                    $('#priority tbody').append(data_row);
                    $('.demo').colorpicker();
                    clear_form();
                }

            });
    });

    $('#create_default').on('click', function(event){
        event.preventDefault();
        $.get("{% url 'project:priority_default' slug %}", function(response){
           if(response){
               window.location="/project/{{slug}}/settings/priorities/";
           }
        });
    });

    $('#project_submenu').attr('class', 'arrow-up active');
    $('#project_submenu ul').show().children('li#project_priorities').addClass('active');

    /* table sortables */
    var fixHelperModified = function(e, tr) {

            var $originals = tr.children();
            var $helper = tr.clone();
            $helper.children().each(function(index) {
                $(this).width($originals.eq(index).width())
            });
            return $helper;
        },
        updateIndex = function(e, ui) {
            $('td.index', ui.item.parent()).each(function (i) {
                $(this).html(i + 1);
            });
            console.log("Start id : " + ui.item.id);
            console.log("Start position: " + ui.item.startPos);
            console.log("New position: " + ui.item.index());
            var prev = ui.item.startPos;
            var current = ui.item.index();
            if(prev != current){
                $.get("{% url 'project:priority_order' slug %}"+"?prev="+prev+"&current="+current);
            }
        }

        $("#priority tbody").sortable({
            helper: fixHelperModified,
            stop: updateIndex,
            start: function(event, ui) {
                ui.item.startPos = ui.item.index();
                ui.item.id = ui.item.id
            },
             update: function( event, ui ) {
                ui.item.id = ui.item.attr("id");
              }
        }).disableSelection();
    /* end sotbales */

    /*inline edit*/
    $('body').on('click','a > .fa-edit',function(e){
        e.preventDefault();
        $row = $(this).closest('tr');
        $(this).attr('class','glyphicon glyphicon-floppy-saved');
        $row.find('input').css({border:'solid 1px #00CC66'});
        $row.find('td:nth-child(3) input').attr('readonly',false)
    });

    /*inline save */
    $('body').on('click','a > .glyphicon.glyphicon-floppy-saved',function(e){
        e.preventDefault();
        $instatnce = $(this)
        $row = $(this).closest('tr');
        var data = $row.find('input').serialize();
        $.post('{% url 'project:priority_edit' slug %}',data, function(response){
            if(response['error']){
                alert("errors")
                $row.find('input').css({border:'none'});
                for (var key in response['errors']) {
                    $input = $row.find('input[name="'+key+'"]');
                    console.log(key)
                    $input.css({border:'solid 1px #FF0000'});
                }

            }
            else{
                alert("no errors")
                $row.find('input').css({border:'none'});
                $row.find('td:nth-child(3) input').attr('readonly',true);
                $instatnce.attr('class','fa fa-edit');
            }
        });
    });
    /* end edit */
    </script>
{% endblock %}
